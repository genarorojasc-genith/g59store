{% extends 'base.html' %}
{% load moneda %}

{% block title %}Checkout{% endblock %}

{% block content %}
<h1 class="text-2xl font-semibold text-gray-900 mb-6">Checkout</h1>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  <!-- Resumen del carrito -->
  <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6">
    <h2 class="text-lg font-semibold mb-4">Resumen de tu carrito</h2>

    <div class="space-y-4">
      {% for item in cart %}
        <div class="flex justify-between text-sm text-gray-700 border-b pb-2">
          <div>
            <p class="font-medium">{{ item.producto.nombre }}</p>
            <p class="text-gray-500">Cantidad: {{ item.quantity }}</p>
          </div>
          <div class="text-right">
            <p>${{ item.price }}</p>
            <p class="text-gray-500 text-xs">Total: {{ item.total_price|formato_pesos }}</p>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="mt-4 text-right">
      <p class="text-base font-semibold text-gray-900">
        Total a pagar: {{ cart.get_total_price|formato_pesos }}
      </p>
    </div>
  </div>

  <!-- Formularios -->
  <div class="bg-white rounded-xl shadow-sm p-6">
    <h2 class="text-lg font-semibold mb-4">Datos de cliente, envío y pago</h2>

    <form method="post" action="{% url 'pedidos:pedido_crear' %}" class="space-y-5" id="checkout-form">
      {% csrf_token %}

      <!-- Cliente (email) -->
      <div>
        <label class="block text-sm font-medium mb-1">Correo de contacto</label>
        {{ form_cliente.email }}
        {% if form_cliente.email.errors %}
          <p class="text-red-600 text-xs mt-1">{{ form_cliente.email.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Envío -->
      <div class="grid grid-cols-1 gap-4">
        <div class="flex items-center justify-between">
          <p class="text-sm font-medium">Datos de envío</p>
          {% if user.is_authenticated and perfil %}
            <label class="inline-flex items-center gap-2 text-xs">
              <input type="checkbox" id="usar_datos_envio" class="rounded border-gray-300">
              Usar datos guardados
            </label>
          {% endif %}
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Nombre de quien recibe</label>
          {{ form_envio.nombre_recibe }}
          {% if form_envio.nombre_recibe.errors %}
            <p class="text-red-600 text-xs mt-1">{{ form_envio.nombre_recibe.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Dirección</label>
          {{ form_envio.direccion_recibe }}
          {% if form_envio.direccion_recibe.errors %}
            <p class="text-red-600 text-xs mt-1">{{ form_envio.direccion_recibe.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Ciudad</label>
          {{ form_envio.ciudad_recibe }}
          {% if form_envio.ciudad_recibe.errors %}
            <p class="text-red-600 text-xs mt-1">{{ form_envio.ciudad_recibe.errors.0 }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Factura -->
      <div class="border-t pt-4">
        <div class="flex items-center justify-between">
          <label class="inline-flex items-center gap-2 text-sm">
            {{ form_factura.requiere_factura }} ¿Requieres factura?
          </label>
          {% if user.is_authenticated and perfil_facturacion %}
            <label class="inline-flex items-center gap-2 text-xs">
              <input type="checkbox" id="usar_datos_facturacion" class="rounded border-gray-300">
              Usar datos de facturación guardados
            </label>
          {% endif %}
        </div>

        <div id="factura-fields" class="mt-3 grid grid-cols-1 gap-4 hidden">
          <div>
            <label class="block text-sm font-medium mb-1">RUT</label>
            {{ form_factura.rut_facturacion }}
            {% if form_factura.rut_facturacion.errors %}
              <p class="text-red-600 text-xs mt-1">{{ form_factura.rut_facturacion.errors.0 }}</p>
            {% endif %}
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Razón social</label>
            {{ form_factura.razon_social }}
            {% if form_factura.razon_social.errors %}
              <p class="text-red-600 text-xs mt-1">{{ form_factura.razon_social.errors.0 }}</p>
            {% endif %}
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Giro (opcional)</label>
            {{ form_factura.giro }}
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Dirección de facturación</label>
            {{ form_factura.direccion_facturacion }}
            {% if form_factura.direccion_facturacion.errors %}
              <p class="text-red-600 text-xs mt-1">{{ form_factura.direccion_facturacion.errors.0 }}</p>
            {% endif %}
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Ciudad</label>
            {{ form_factura.ciudad_facturacion }}
            {% if form_factura.ciudad_facturacion.errors %}
              <p class="text-red-600 text-xs mt-1">{{ form_factura.ciudad_facturacion.errors.0 }}</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Pago -->
      <div class="border-t pt-4">
        <label class="block text-sm font-medium mb-1">Método de pago</label>
        {{ form_pedido.metodo_pago }}
        {% if form_pedido.metodo_pago.errors %}
          <p class="text-red-600 text-xs mt-1">{{ form_pedido.metodo_pago.errors.0 }}</p>
        {% endif %}
      </div>

      <div class="mt-4 p-3 bg-slate-50 rounded-md text-xs text-slate-700">
        <p class="font-semibold">Información sobre envíos:</p>
        <ul class="list-disc pl-4 mt-1 space-y-1">
          <li>En <span class="font-semibold">Santiago</span> el envío es <span class="font-semibold">gratis</span>.</li>
          <li>Para <span class="font-semibold">regiones</span>, el envío es <span class="font-semibold">por pagar</span> (Starken, etc.).</li>
        </ul>
      </div>

      <button type="submit"
        class="w-full mt-4 inline-flex justify-center items-center px-4 py-2
               text-sm font-medium rounded-md text-white
               bg-emerald-600 hover:bg-emerald-700 shadow">
        Confirmar pedido y continuar al pago
      </button>
    </form>
  </div>
</div>

<script>
  (function () {
    // Mostrar / ocultar campos de factura
    const cbFactura = document.getElementById("id_requiere_factura");
    const boxFactura = document.getElementById("factura-fields");
    function toggleFactura() {
      if (!cbFactura || !boxFactura) return;
      boxFactura.classList.toggle("hidden", !cbFactura.checked);
    }
    if (cbFactura && boxFactura) {
      toggleFactura();
      cbFactura.addEventListener("change", toggleFactura);
    }

    // Datos guardados de perfil (envío)
    {% if user.is_authenticated and perfil %}
    const perfilEnvio = {
      nombre: "{{ perfil.nombre|default_if_none:''|escapejs }}",
      direccion: "{{ perfil.direccion_usuario|default_if_none:''|escapejs }}",
      ciudad: "{{ perfil.ciudad|default_if_none:''|escapejs }}"
    };
    {% else %}
    const perfilEnvio = null;
    {% endif %}

    // Datos guardados de facturación
    {% if user.is_authenticated and perfil_facturacion %}
    const perfilFact = {
      rut: "{{ perfil_facturacion.rut_facturacion|default_if_none:''|escapejs }}",
      razon: "{{ perfil_facturacion.razon_social|default_if_none:''|escapejs }}",
      giro: "{{ perfil_facturacion.giro|default_if_none:''|escapejs }}",
      direccion: "{{ perfil_facturacion.direccion_facturacion|default_if_none:''|escapejs }}",
      ciudad: "{{ perfil_facturacion.ciudad_facturacion|default_if_none:''|escapejs }}"
    };
    {% else %}
    const perfilFact = null;
    {% endif %}

    // Checkbox "usar datos guardados" para envío
    const chkEnvio = document.getElementById("usar_datos_envio");
    if (chkEnvio && perfilEnvio) {
      chkEnvio.addEventListener("change", function () {
        if (!this.checked) return;
        const nombreInput = document.getElementById("id_nombre_recibe");
        const dirInput    = document.getElementById("id_direccion_recibe");
        const ciudadInput = document.getElementById("id_ciudad_recibe");

        if (nombreInput) nombreInput.value = perfilEnvio.nombre || "";
        if (dirInput)    dirInput.value    = perfilEnvio.direccion || "";
        if (ciudadInput) ciudadInput.value = perfilEnvio.ciudad || "";
      });
    }

    // Checkbox "usar datos de facturación guardados"
    const chkFact = document.getElementById("usar_datos_facturacion");
    if (chkFact && perfilFact) {
      chkFact.addEventListener("change", function () {
        if (!this.checked) return;

        // Aseguramos que se muestren los campos de factura
        if (cbFactura && !cbFactura.checked) {
          cbFactura.checked = true;
          toggleFactura();
        }

        const rutInput   = document.getElementById("id_rut_facturacion");
        const razonInput = document.getElementById("id_razon_social");
        const giroInput  = document.getElementById("id_giro");
        const dirFInput  = document.getElementById("id_direccion_facturacion");
        const ciuFInput  = document.getElementById("id_ciudad_facturacion");

        if (rutInput)   rutInput.value   = perfilFact.rut || "";
        if (razonInput) razonInput.value = perfilFact.razon || "";
        if (giroInput)  giroInput.value  = perfilFact.giro || "";
        if (dirFInput)  dirFInput.value  = perfilFact.direccion || "";
        if (ciuFInput)  ciuFInput.value  = perfilFact.ciudad || "";
      });
    }
  })();
</script>
{% endblock %}
